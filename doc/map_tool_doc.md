

# マップ作成ツール
2021-12-27

## マップ素材サイト
http://yms.main.jp/page-msets/forest1.html


## 草案 12/28
もっとシンプルなマップ表現を...。



## 草案 12/27

フィールド素材テーブル　field_materials

	id	ID
	field_material_name	フィールド素材名
	img_fp	画像ファイルパス
	cell_size_x	セルサイズX
	cell_size_y	セルサイズY
	map_width	マップ横幅
	map_height	マップ縦幅
	x_cnt	Xセル数
	y_cnt	Yセル数
	note	ノート
	
---------------


フィールド素材セルテーブル fmt_cells

	id	ID
	field_material_id	フィールド素材ID
	fmt_cell_name	フィールド素材セル名
	fmt_x	フィールド素材位置X
	fmt_y	フィールド素材位置Y
	fmt_cell_type_id	セルタイプID
	fmt_cell_b_type_id	セルBタイプID
	neighbor_fmt_cell_id	隣セルID
	mark_color	印色
	
---------------

フィールドセルタイプ　fmt_cell_types

	id
	fmt_cell_type_name フィールドセルタイプ名
	note
	
---------------

map_infos	マップインフォメーションテーブル

	id
	map_index_name	マップ名
	layer1_draft_img
	lyaer2_draft_img
	note
	map_data
	
---------------

マップデータ
	マップエンティティ

	id
	map_info_id
	fmt_cell_id
	field_material_id
	x
	y
	preset	プリセット
	layer1_field_material_id
	layer1_x
	layer1_y
	layer2_field_material_id
	layer2_x
	layer2_y



## マップ作製処理

### 実装箇所

マップ作製処理はマップ管理画面の編集フォームに実装する予定

	
---------------

### 課題

- バッチ系の処理になるかもしれない。
- 非常に長い処理になることも考えられる。DBも活用したほうがいいだろうか？


### マップデータ

マップ作製処理はマップデータを作成する処理。
マップデータはマップエンティティのリストになる。

マップデータの目的。ゲームフィールド上のマップ生成を用意にする。



### マップエンティティ

### シナリオ

```

※長い処理になるのでログ出力も行う。

ログファイルのテキストをクリアする。
メモリ情報の書き出し。

GETパラメータからマップインフォメーションIDを取得する。

マップインフォメーションIDを指定してDBからマップインフォメーションエンティティを取得する。

マップインフォメーションエンティティから下書きマップ画像1を取得（layer1_draft_img）


レイヤー1下書き画像から横幅と縦幅をcnt_x,cnt_yとして取得する
マップデータを宣言
cnt_xのループ
	cnt_yのループ
		下書き画像1からx,yに紐づく色を印色として取得する。
		マップエンティティのデフォルトを生成。
		マップエンティティのx,yにセット
		マップインフォメーションIDをセット
		マップエンティティに印色をセットする。
		
マップテーブルからマップインフォメーションIDに紐づくレコードを削除する。


マップデータをマップテーブルにINSERT


マップテーブルからマップインフォメーションIDに紐づくレコードをマップデータとして再取得。


フィールド素材セル・ハッシュマップを取得する（キーは印色）



マップデータをループ
	マップエンティティから印色を取得する
	フィールド素材セル・ハッシュマップから印色に紐づくフィールド素材セルエンティティを取得する。
	マップエンティティにフィールド素材セルエンティティの下記プロパティをセットする
		fmt_cell_id ← フィールド素材セルエンティティのid
		field_material_id ← field_material_id
		layer1_x ← fmt_x
		layer1_y ← fmt_y
		preset ← 1
		
マップデータからマップHm[cnt_x][cnt_y]を作成する。
	Hm[x][y] = マップデータのindex


マップデータをループ
	マップエンティティのプリセットが1以外ならcontinue
	マップエンティティ→フィールド素材セルエンティティ→セルタイプと隣セルIDを取得
	セルタイプが境界型Aである場合
		上右下左のセルを確認し、隣セルIDであるか調べる。（隣接情報の取得）
		0,0,0,0
			なにもせず
		0,0,0,1
			fmt_y + 












			

処理中のセルが海、上が草原である。
	上半分が草原、下半分が海の素材セルx,素材セルyがセットされる。
	上境界フラグに1がセットされる。




```
